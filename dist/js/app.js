"use strict";function initMap(){map=new google.maps.Map($("#map").get(0),{center:start_point,styles:mapstyles,zoom:9,mapTypeControl:!1}),ko.applyBindings(new ViewModel)}var start_point={lat:37.387474,lng:-122.057543},wikipedia_api_url="https://free-api.heweather.com/s6/weather/forecast?location=%E5%9C%A3%E4%BD%95%E5%A1%9E&key=7959b2d195af4b38a2afe26eccd7493f&lang=cn&unit=m",ViewModel=function(){var e=this;this.current=ko.observable(),this.use_poi_icon=ko.observable(),this.markers=ko.observableArray([]),this.infoWindow=new google.maps.InfoWindow,this.centerMarker=new google.maps.Marker({position:start_point,title:"硅谷",animation:google.maps.Animation.DROP,id:1}),map.addListener("bounds_changed",function(){var o=new google.maps.places.Autocomplete($("#search-place").get(0),{bounds:map.getBounds()});o.addListener("place_changed",function(){var t=o.getPlace();e.searchPlaces(t.formatted_address)})}),e.centerMarker.addListener("click",function(){e.showCenterInfoWindow(this,e.infoWindow)}),e.centerMarker.setMap(map),this.showCenterInfoWindow=function(e,o){o.marker!=e&&(o.marker=e,fetch("http://api.map.baidu.com/telematics/v3/weather?location=%E5%8C%97%E4%BA%AC&output=json&ak=BxHHQAtW62yaGYTQnDjhlethS8brEAzf",{mode:"no-cors"}),fetch("https://api.foursquare.com/v2/venues/4d9a662a674ca14376eaba43?client_id=NONGGLXBKX5VFFIKKEK1HXQPFAFVMEBTRXBWJUPEN4K14JUE&client_secret=ZZDD1SLJ4PA2X4AJ4V23OOZ53UM4SFZX0KORGWP5TZDK4YYJ&v=20130815"),fetch(wikipedia_api_url).then(function(e){return e.json()}).then(function(t){forecast=t.HeWeather6[0].daily_forecast,console.log(forecast[0]),console.log(forecast[1]),console.log(forecast[2]),html="<div><h1>硅谷-天气</h1><ul>",forecast.forEach(function(e){html+="<li>"+e.date+": 白天"+e.cond_txt_d+"，晚上"+e.cond_txt_n+" 最低"+e.tmp_min+"摄氏度 最高"+e.tmp_max+"摄氏度 "+e.wind_dir+" "+e.wind_sc+"</li>"}),html+="</ul></div>",console.log(html),o.setContent(html),o.open(map,e),o.addListener("closeclick",function(){o.marker=null})}).catch(function(e){console.log(e)}))},this.search=function(){var o=this.current().trim();o&&e.searchPlaces(o)},this.searchPlaces=function(o){if(null==o&&(o=$("#search-place").get(0).value),o.length=0)window.alert("You must enter an address.");else{e.clearMarkers();var t=map.getBounds();new google.maps.places.PlacesService(map).textSearch({query:o,bounds:t},function(o,t){t===google.maps.places.PlacesServiceStatus.OK&&e.createMarkersForPlaces(o)})}},this.createMarkersForPlaces=function(o){for(var t=new google.maps.LatLngBounds,a=0;a<o.length;a++){var n=o[a],i=void 0;(i=e.use_poi_icon()?new google.maps.Marker({map:map,icon:{url:n.icon,size:new google.maps.Size(35,35),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(15,34),scaledSize:new google.maps.Size(25,25)},title:n.name,position:n.geometry.location,id:n.place_id}):new google.maps.Marker({map:map,title:n.name,position:n.geometry.location,id:n.place_id})).addListener("click",function(){e.populateInfoWindow(this,e.infoWindow)}),e.markers.push(i),n.geometry.viewport?t.union(n.geometry.viewport):t.extend(n.geometry.location)}map.fitBounds(t)},this.clearMarkers=function(){console.log("clearMarkers"),e.markers().forEach(function(e){e.setMap(null)}),e.markers.removeAll(),e.infoWindow.marker=null},this.showPlaceInfo=function(e){google.maps.event.trigger(e,"click"),$("#nav").removeClass("open")}.bind(this),this.populateInfoWindow=function(e,o){if(o.marker!=e){o.marker=e;new google.maps.places.PlacesService(map).getDetails({placeId:e.id},function(t,a){if(a===google.maps.places.PlacesServiceStatus.OK){var n="<div>";t.name&&(n+="<strong>"+t.name+"</strong>"),t.formatted_address&&(n+="<br>"+t.adr_address),t.formatted_phone_number&&(n+="<br>"+t.formatted_phone_number),t.photos&&(n+='<br><br><img src="'+t.photos[0].getUrl({maxHeight:100,maxWidth:200})+'">'),n+="</div>",o.setContent(n),o.open(map,e)}}),o.addListener("closeclick",function(){o.marker=null})}},this.toggleNav=function(){$("#nav").toggleClass("open"),event.stopPropagation()}};